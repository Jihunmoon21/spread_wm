defaults:
  - _self_
  - planner: mpc_cem
  - override hydra/launcher: submitit_slurm

hydra:
  run:
    dir: plan_outputs/${now:%Y%m%d%H%M%S}_${replace_slash:${model_name}}_gH${goal_H}
  sweep:
    dir: plan_outputs/${now:%Y%m%d%H%M%S}_${replace_slash:${model_name}}_gH${goal_H}
    subdir: ${hydra.job.num}
  launcher:
    submitit_folder: ${hydra.sweep.dir}/.submitit/%j
    nodes: 1
    tasks_per_node: 1
    cpus_per_task: 16
    mem_gb: 256
    gres: "gpu:h100:1"
    qos: "explore"
    timeout_min: 720
    setup: ["export DEBUGVAR=$(scontrol show hostnames $SLURM_JOB_NODELIST)",
            export MASTER_ADDR="$(scontrol show hostnames $SLURM_JOB_NODELIST | head -n 1)",
            "export MASTER_PORT=$(for port in $(shuf -i 30000-65500 -n 20); do if [[ $(netstat -tupln 2>&1 | grep $port | wc -l) -eq 0 ]] ; then echo $port; break; fi; done;)",]

# model to load for planning
ckpt_base_path: /home/jihun/spread # put absolute path here. Checkpoints will be loaded from ${ckpt_base_path}/outputs
model_name: null
model_epoch: latest # 임의 조정

seed: 99
n_evals: 10 # 25
goal_source: 'random_state' # 'random_state' or 'dset' or 'random_action' 
goal_H: 5 # specifies how far away the goal is if goal_source is 'dset'
n_plot_samples: 10

debug_dset_init: False

objective:
  _target_: planning.objectives.create_objective_fn
  alpha: 1
  base: 2 # coeff base for weighting all frames. Only applies when mode == 'all'
  mode: last

lora:
  enabled: false # LoRA 자체를 사용할지 여부
  online: false   # LoRA 사용 시, 온라인 모드를 쓸지 여부 (false면 일반 LoRA)
  rank: 8        # LoRA의 rank
  lr: 5e-4
  steps: 100              # planning 시작 전에 적응 스텝 수
  update_every_steps: 0   # online=true일 때만 사용 (0이면 비활성)
  
  # LoRA 적층 관련 설정 (online=true일 때만 사용)
  loss_window_length: 5                    # Loss window 크기
  loss_window_mean_threshold: 0.1          # Loss 평균 임계값
  loss_window_variance_threshold: 1e-5      # Loss 분산 임계값
  min_steps_for_stack: 30                   # 최소 스텝 수 (적층 간격)
  
  # 하이브리드 적층 설정
  hybrid_stacking:
    enabled: true                    # 하이브리드 적층 활성화
    task_based_stacking: true        # 태스크 변경 시 적층
    loss_based_stacking: false        # Loss plateau 시 적층
    max_stacks_per_task: 3           # 태스크당 최대 적층 횟수
    stack_type_tracking: true        # 적층 타입별 추적
  
  # Loss 가중치 (설정 파일에 없는 경우 기본값 사용)
  visual_loss_weight: 1.0
  proprio_loss_weight: 0.3

  # Loss 기반 태스크 전환 설정
  task_switch:
    enabled: true                    # Loss 기반 태스크 전환 활성화
    loss_threshold: 0.1              # Loss 임계값 (이 값 이하로 떨어지면 다음 태스크로)
    loss_window_size: 1              # 태스크 전환용 Loss window 크기
    max_planning_per_task: 1000        # 최대 플래닝 횟수 (무한 루프 방지)
    min_planning_per_task: 10         # 최소 플래닝 횟수 (너무 빨리 넘어가는 것 방지)